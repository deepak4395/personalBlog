name: Generate AI Content

on:
  # Run on every push (remove this after website is stable)
  push:
    branches:
      - main
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      agent:
        description: 'Which agent to run (news, tutorials, all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - news
          - tutorials
  
  # Scheduled triggers
  schedule:
    # News: Daily at 6 AM UTC
    - cron: '0 6 * * *'
    # Tutorials: Mondays at 8 AM UTC
    - cron: '0 8 * * 1'

jobs:
  generate-content:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    outputs:
      has_changes: ${{ steps.check-changes.outputs.has_changes }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm -r run build

      - name: Create secrets file from GitHub Secrets
        run: |
          cat > config/secrets.yaml << 'EOF'
          ai:
            google:
              apiKey: "${{ secrets.GEMINI_API_KEY }}"
              model: "gemini-2.0-flash-exp"
            groq:
              apiKey: "${{ secrets.GROQ_API_KEY }}"
              model: "llama-3.3-70b-versatile"
            openai:
              apiKey: "${{ secrets.OPENAI_API_KEY }}"
              model: "gpt-4o-mini"
          
          social:
            reddit:
              clientId: "${{ secrets.REDDIT_CLIENT_ID }}"
              clientSecret: "${{ secrets.REDDIT_CLIENT_SECRET }}"
              userAgent: "personalBlog/1.0"
            stackexchange:
              apiKey: "${{ secrets.STACKEXCHANGE_API_KEY }}"
          
          email:
            formsubmit:
              email: "${{ secrets.FORMSUBMIT_EMAIL }}"
          EOF

      - name: Determine which agent to run
        id: determine-agent
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "agent=${{ github.event.inputs.agent }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.schedule }}" = "0 6 * * *" ]; then
            echo "agent=news" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.schedule }}" = "0 8 * * 1" ]; then
            echo "agent=tutorials" >> $GITHUB_OUTPUT
          else
            echo "agent=all" >> $GITHUB_OUTPUT
          fi

      - name: Run AI agents
        run: |
          echo "Running agent: ${{ steps.determine-agent.outputs.agent }}"
          if [ "${{ steps.determine-agent.outputs.agent }}" = "all" ]; then
            pnpm agents:all
          else
            pnpm agents:${{ steps.determine-agent.outputs.agent }}
          fi
          echo "Agent execution completed"
          echo "Checking output directory..."
          find website/src/content -type f -name "*.md" ! -name ".gitkeep.md" || echo "No markdown files found"
        env:
          SOPS_AGE_KEY_FILE: ~/.config/sops/age/keys.txt

      - name: Check for new content
        id: check-changes
        run: |
          echo "Checking for new content files..."
          ls -la website/src/content/news/ || echo "News directory is empty or doesn't exist"
          ls -la website/src/content/tutorials/ || echo "Tutorials directory is empty or doesn't exist"
          
          git add website/src/content/
          
          if git diff --cached --quiet website/src/content/; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected!"
            git diff --cached --name-status website/src/content/
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      # Build website and prepare for deployment
      - name: Build website
        run: |
          pnpm --filter website build
          # Copy dist to docs for GitHub Pages
          rm -rf docs
          cp -r website/dist docs

      - name: Commit and push changes
        run: |
          git config user.name "AI Content Bot"
          git config user.email "bot@github.com"
          git add website/src/content/ || true
          git add docs/
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            if [ "${{ steps.check-changes.outputs.has_changes }}" = "true" ]; then
              git commit -m "Add AI-generated blog post (.md) and built website (HTML)"
            else
              git commit -m "Rebuild website"
            fi
            git push
          fi
